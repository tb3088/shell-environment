#----- header -----
[ "${0##*/}" != "${BASH_SOURCE##*/}" ] || { >&2 echo -e "ERROR\tfile must be sourced ($0)"; return 2; }

# must allow multiple invocation
#------------------

# Usage:
#   1) symlink: .bashrc_mvn -> .bashrc_3rdparty
#   2) args: .bashrc_3rdparty mvn java

declare -A __3rdparty_map=(
    ['aws']=${AWSCLI:-'aws{cli,}{v,}'$AWS_VERSION}
    ['mvn']=apache-maven
    ['java']=${JAVA_HOME:-'j{re,dk,se}{-,}'$JAVA_VERSION}
    ['puppet']=${PUPPET_BASE:-puppetlabs}
    ['go']=${GOROOT:-'go{,lang}{-,}'$GO_VERSION}
    ['ruby']=${RUBY_BASE:-'ruby{-,}'$RUBY_VERSION}
  )

function add_program() {
  is_exec "${1:?}" && return

  local m=${__3rdparty_map[$1]}
  [ -n "$m" ] || { log.error "unknown software ($1)"; return; }

  if [ "${m:0:1}" = '/' ]; then
    for p in "$m"{/bin,}; do
      [ -x "$p/$1" ] && { addPath "$p"; break; }
    done
    return
  fi 

  #TODO https://unix.stackexchange.com/questions/406216/check-for-bash-options
  local pbin=$(
      shopt -s nullglob extglob globstar
      shopt -u failglob

      # process embedded glob patterns
      for v in `eval echo "$m"`; do
        # WARN '/**/' can be VERY slow
        for p in {/opt,/usr/local,"$PROGRAMFILES","$LOCALAPPDATA"}/"$v"*{/bin,}; do
          [ -x "$p/$1" ] && { echo "$p"; break 2; }
        done
      done
    )
  [ -n "$pbin" ] && addPath "$pbin"
}


s=`__READLINK -e "$BASH_SOURCE"`
k="${BASH_SOURCE#*.bashrc_}"
if [ "${s#*.bashrc_}" != "$k" ]; then
  add_program "$k" &&
      log.info "added to PATH ($k)" || log.warn "software not found ($k)"
  # automatic-mode (via symlink) is forgiving
  return 0
fi

while (( $# )); do
  [ -n "$1" ] || { shift; continue; }
  add_program "$1" &&
      log.info "added to PATH ($1)" || {
      log.warn "software not found ($1)" "skipped: ${@:1}"; break
    }
  shift
done

return


# vim: expandtab:ts=4:sw=4
